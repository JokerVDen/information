## Паттерн Сага

Паттерн Сага - это шаблон проектирования, используемый для управления длительными и распределенными транзакциями в распределенных системах. Он разбивает длинные и сложные транзакции на более мелкие и более простые шаги, называемые компенсирующими транзакциями.

### Основные компоненты паттерна Сага:

1. **Инициирующая транзакция (Initiating Transaction)**:
    - Первая транзакция, которая запускает цепочку действий в паттерне Сага. Она координирует выполнение последующих шагов и обрабатывает успешное или неудачное завершение всей транзакции.

2. **Шаги транзакции (Transaction Steps)**:
    - Каждый шаг транзакции представляет собой отдельную операцию или сервис, которая выполняется в рамках паттерна Сага. Эти шаги могут включать операции записи данных или вызовы удаленных сервисов.

3. **Компенсирующие транзакции (Compensating Transactions)**:
    - Каждый шаг транзакции имеет свою компенсирующую транзакцию, которая отменяет или компенсирует эффекты выполненной операции в случае неудачи. Компенсирующие транзакции используются для восстановления целостности данных в системе в случае сбоев.

#### Примеры компенсирующих транзакций:

1. **Отмена заказа продукта:**
    - Если покупатель отменил заказ товара, компенсирующая транзакция может быть возврат денег на его счет или аннулирование транзакции оплаты.

2. **Отмена банковского перевода:**
    - В случае неправильного банковского перевода, компенсирующая транзакция может быть переводом средств обратно на счет отправителя.

3. **Отмена операции с кредитной картой:**
    - Если клиент отменил операцию с кредитной картой, компенсирующая транзакция может быть аннулированием транзакции или возвратом средств на кредитную карту.

4. **Отмена бронирования билета на самолет:**
    - В случае отмены планов поездки, компенсирующая транзакция может быть возвратом денег за билет или предоставлением возможности перебронирования на другой рейс.

5. **Отмена подписки на сервис:**
    - Если пользователь отменил подписку на сервис, компенсирующая транзакция может быть возвратом средств за неиспользованный период подписки.

6. **Отмена банковского чека:**
    - В случае утери или ненадлежащего использования банковского чека, компенсирующая транзакция может быть аннулированием чека и возвратом средств.

7. **Отмена бронирования автомобиля:**
    - Если клиент отменил бронирование автомобиля, компенсирующая транзакция может быть возвратом средств или предоставлением возможности переноса бронирования на другую дату.

8. **Отмена транзакции в онлайн-магазине:**
    - В случае отмены покупки в интернет-магазине, компенсирующая транзакция может быть возвратом средств на банковскую карту клиента.

### Преимущества паттерна Сага:

- Обеспечивает обработку длительных и распределенных транзакций.
- Уменьшает блокировки и улучшает параллелизм операций.
- Повышает отказоустойчивость системы путем обработки сбоев на уровне шагов транзакции.
- Позволяет реализовать компенсационные механизмы для отката транзакций.

### Недостатки паттерна Сага:

- Усложняет управление транзакциями и контроль над их состоянием.
- Требует внимательного проектирования компенсирующих транзакций для обеспечения целостности данных.
- Может потребовать дополнительных механизмов мониторинга и управления выполнением транзакций.

Паттерн Сага является мощным инструментом для обеспечения целостности данных и обработки длительных и распределенных транзакций в распределенных системах. Однако его использование требует тщательного проектирования и реализации, чтобы обеспечить надежное и безопасное выполнение бизнес-процессов.

---

Хореография и оркестровка - два основных подхода к координации выполнения бизнес-процессов в распределенных системах. Давайте рассмотрим их более подробно:

### Хореография (Choreography)

Хореография представляет собой способ координации выполнения бизнес-процессов, при котором каждая транзакция или сервис публикует события, которые запускают выполнение транзакций в других сервисах. В этом случае, нет централизованного управляющего компонента, который бы контролировал порядок выполнения операций. Вместо этого, система реагирует на события и действия других сервисов, опираясь на информацию, полученную из этих событий.

#### Преимущества хореографии:
- Децентрализация: Каждый сервис сам принимает решения о своих действиях, что делает систему более гибкой и масштабируемой.
- Уменьшение связности: Компоненты системы взаимодействуют через обмен событиями, что позволяет снизить степень их взаимосвязи.

#### Недостатки хореографии:
- Сложность управления: Сложно отслеживать и контролировать последовательность действий в сложных бизнес-процессах.
- Согласованность: Обеспечение согласованности данных может быть сложной задачей, особенно при взаимодействии нескольких сервисов.

#### Пример хореографии:

1. Сервис инвентаризации публикует событие "Товар зарезервирован".
2. Сервис оплаты подписан на событие "Товар зарезервирован" и автоматически начинает процесс оплаты.
3. После успешной оплаты, сервис доставки подписан на событие "Оплата завершена" и начинает процесс доставки товара.


### Оркестровка (Orchestration)

Оркестровка представляет собой подход к координации выполнения бизнес-процессов, при котором есть централизованный управляющий компонент, известный как оркестратор. Оркестратор определяет порядок выполнения транзакций и управляет передачей данных и контролем выполнения между различными сервисами.

#### Преимущества оркестровки:
- Централизованное управление: Оркестратор принимает решения о порядке выполнения действий и координирует выполнение бизнес-процессов.
- Прозрачность: Логика выполнения более явно определена и контролируется, что облегчает отладку и мониторинг.

#### Недостатки оркестровки:
- Одиночная точка отказа: Оркестратор становится единственной точкой отказа, и его сбой может привести к остановке всей системы.
- Увеличение связности: Сервисы должны быть интегрированы и зависеть от оркестратора, что может увеличить степень их взаимосвязи.

Выбор между хореографией и оркестровкой зависит от требований вашей системы, ее архитектуры и контекста использования.

### Пример оркестровки:

1. Оркестратор получает запрос на оформление заказа.
2. Оркестратор вызывает сервис инвентаризации для проверки наличия товара.
3. Если товар есть в наличии, оркестратор вызывает сервис оплаты.
4. После успешной оплаты, оркестратор вызывает сервис доставки для отправки товара.

[На главную Оркестратор](../main.md)
