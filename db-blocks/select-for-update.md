## Зачем нужен `SELECT … FOR UPDATE`

`SELECT ... FOR UPDATE` - это SQL-запрос, который используется для блокировки выбранных строк в таблице. Это может быть
полезным в многопользовательских приложениях, где несколько пользователей могут пытаться получить доступ к одним и тем
же данным одновременно.

Когда вы выполняете `SELECT ... FOR UPDATE`, строки, которые соответствуют вашему запросу, блокируются для других
транзакций. Это означает, что другие транзакции не смогут изменить или удалить эти строки до тех пор, пока блокировка не
будет снята.

Основные сценарии использования `SELECT ... FOR UPDATE` включают:

1. **Предотвращение конфликтов**: Если несколько пользователей пытаются изменить одни и те же строки данных,
   использование `SELECT ... FOR UPDATE` может предотвратить конфликты, обеспечив блокировку строк во время чтения.

2. **Гарантированное обновление**: Если вы планируете сразу же изменить данные, которые вы выбрали,
   использование `SELECT ... FOR UPDATE` гарантирует, что данные не будут изменены кем-то другим в то время, когда они
   заблокированы.

3. **Предотвращение чтения устаревших данных**: Блокировка строк при чтении обеспечивает целостность данных и
   предотвращает чтение устаревших данных, которые могли бы быть изменены другими процессами.

Однако следует быть осторожным при использовании `SELECT ... FOR UPDATE`, так как это может привести к потенциальным
проблемам с производительностью, если блокировка длится слишком долго, или к блокировкам, которые могут замедлить работу
приложения.

### Пример использования SELECT ... FOR UPDATE

Предположим, у нас есть таблица `accounts`, которая содержит информацию о банковских счетах пользователей. Мы хотим
выбрать данные о конкретном счете и заблокировать его, чтобы никакой другой процесс не мог изменить его баланс во время
операции чтения.

```sql
-- Создание таблицы accounts
CREATE TABLE accounts
(
    id      INT PRIMARY KEY,
    name    VARCHAR(50),
    balance DECIMAL(10, 2)
);

-- Вставка некоторых данных
INSERT INTO accounts (id, name, balance)
VALUES (1, 'John Doe', 1000.00),
       (2, 'Jane Smith', 2500.00);

-- Начало транзакции
BEGIN;

-- Выбор данных о счете с id=1 и блокировка этой строки
SELECT *
FROM accounts
WHERE id = 1
FOR UPDATE;

-- Выполнение операций чтения/изменения данных

-- Конец транзакции
COMMIT;
```

1. Создаем таблицу accounts, где хранится информация о счетах пользователей.
2. Вставляем несколько записей в таблицу accounts для демонстрации работы с данными.
3. Начинаем транзакцию.
4. Выполняем операцию выбора данных о счете с использованием SELECT ... FOR UPDATE для блокировки этой строки.
5. Проводим операции чтения или изменения данных.
6. Завершаем транзакцию.

Пример laravel:

```php
use App\Models\Account;

// Начало транзакции
DB::beginTransaction();

// Выбор данных о счете с id=1 и блокировка этой строки
$account = Account::where('id', 1)->lockForUpdate()->first();

// Выполнение операций чтения/изменения данных
// Например, увеличение баланса на 100
$account->balance += 100;
$account->save();

// Конец транзакции
DB::commit();
```

[На главную Блокировка БД](main.md)